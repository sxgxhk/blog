---
import Layout from '../layouts/Layout.astro';
import { getAllPosts, getYear, formatDate, extractSlug } from '../lib/wp';

const posts = await getAllPosts();
const currentYear = new Date().getFullYear().toString();

// 按年份分组
const postsByYear = posts.reduce((acc, post) => {
  const year = getYear(post.date);
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<string, typeof posts>);

// 排序年份（最新优先）
const years = Object.keys(postsByYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<Layout title="文章归档" description="方糖博客文章归档">
  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-2">文章归档</h1>
    <p class="text-gray-500">共 {posts.length} 篇文章</p>
  </div>
  
  <div class="space-y-4">
    {years.map((year) => {
      const isCurrentYear = year === currentYear;
      return (
        <section class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
          <button 
            class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800/50 flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
            onclick={`document.getElementById('year-${year}').classList.toggle('hidden')`}
          >
            <span class="font-bold text-lg">{year}年</span>
            <span class="text-sm text-gray-500">{postsByYear[year].length} 篇</span>
          </button>
          
          <div id={`year-${year}`} class={isCurrentYear ? '' : 'hidden'}>
            <div class="divide-y divide-gray-100 dark:divide-gray-800">
              {postsByYear[year].map((post) => (
                <article class="flex items-baseline gap-4 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-800/30 transition-colors">
                  <time class="text-sm text-gray-400 w-16 flex-shrink-0">
                    {new Date(post.date).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })}
                  </time>
                  <a 
                    href={`/${extractSlug(post.link)}.html`} 
                    class="hover:text-primary transition-colors flex-1"
                  >
                    <Fragment set:html={post.title.rendered} />
                  </a>
                </article>
              ))}
            </div>
          </div>
        </section>
      );
    })}
  </div>
</Layout>

---
import Layout from '../../layouts/Layout.astro';
import { getTags, getPostsByTag, formatDate, extractSlug , cleanExcerpt, stripHtml} from '../../lib/wp';

export async function getStaticPaths() {
  const tags = await getTags();
  
  return tags.map((tag) => ({
    params: { tag: tag.id.toString() },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const posts = await getPostsByTag(tag.id);
---

<Layout title={`标签: ${tag.name}`} description={`方糖博客标签: ${tag.name}`}>
  <div class="mb-8">
    <h1 class="text-2xl font-bold mb-2">
      标签: {tag.name}
    </h1>
    <p class="text-gray-500">共 {posts.length} 篇文章</p>
  </div>
  
  <div class="space-y-6">
    {posts.map((post) => (
      <article class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-6 hover:shadow-lg transition-shadow">
        <h2 class="text-xl font-bold mb-2">
          <a href={`/${extractSlug(post.link)}.html`} class="hover:text-primary transition-colors">
            <Fragment set:html={post.title.rendered} />
          </a>
        </h2>
        
        <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-3">
          <time datetime={post.date}>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            {formatDate(post.date)}
          </time>
        </div>
        
        <p class="text-gray-600 dark:text-gray-300 line-clamp-6">{post.content?.rendered ? stripHtml(post.content.rendered).substring(0, 400) + "..." : ""}</p>
        
        <a href={`/${extractSlug(post.link)}.html`} class="inline-flex items-center mt-3 text-primary hover:underline">
          阅读全文
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </a>
      </article>
    ))}
  </div>
</Layout>

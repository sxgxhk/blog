// WordPress 博客
(function() {
    var USE_PROXY = true;
    var TWIKOO = 'twikoo.iblue.eu.org';

    function getApi(endpoint, params) {
        params = params || {};
        var url = USE_PROXY ? 'api.php?endpoint=' + endpoint : 'https://fangtang.net/wp-json/wp/v2/' + endpoint;
        var qs = [];
        for (var k in params) qs.push(k + '=' + encodeURIComponent(params[k]));
        return url + (qs.length ? '?' + qs.join('&') : '');
    }

    var currentPage = 1, currentCat = 'all', totalPages = 1;

    function init() {
        loadPosts();
        checkUrl();
        
        var cats = document.querySelectorAll('.cat-item');
        for (var i = 0; i < cats.length; i++) {
            cats[i].addEventListener('click', function(e) {
                e.preventDefault();
                currentCat = this.getAttribute('data-cat');
                currentPage = 1;
                
                var allCats = document.querySelectorAll('.cat-item');
                for (var j = 0; j < allCats.length; j++) allCats[j].classList.remove('active');
                this.classList.add('active');
                
                showList();
                loadPosts();
            });
        }
    }

    function checkUrl() {
        var id = getQueryParam('id');
        if (id) showPost(id);
    }

    function getQueryParam(name) {
        var url = window.location.search;
        var regex = new RegExp('[?&]' + name + '=([^&]*)');
        var results = regex.exec(url);
        return results ? decodeURIComponent(results[1]) : null;
    }

    function showList() {
        document.getElementById('postList').style.display = 'flex';
        document.getElementById('article').style.display = 'none';
        document.getElementById('archives').style.display = 'none';
        document.getElementById('pagination').style.display = 'flex';
    }

    function loadPosts() {
        var loading = document.getElementById('loading');
        var postList = document.getElementById('postList');
        
        loading.style.display = 'block';
        postList.style.display = 'none';
        
        var url = getApi('posts', { _embed: true, per_page: 15, page: currentPage });
        
        if (currentCat !== 'all') {
            getCategoryId(currentCat, function(catId) {
                if (catId) {
                    url = getApi('posts', { _embed: true, per_page: 15, page: currentPage, categories: catId });
                }
                fetchPosts(url);
            });
        } else {
            fetchPosts(url);
        }
    }

    function fetchPosts(url) {
        fetch(url).then(function(r) { return r.json(); })
        .then(function(posts) {
            try {
                totalPages = parseInt(posts.length / 15) + 1;
            } catch(e) { totalPages = 1; }
            
            var html = '';
            for (var i = 0; i < posts.length; i++) {
                var p = posts[i];
                var cat = '';
                try { cat = p._embedded['wp:term'][0][0].name; } catch(e) {}
                var d = new Date(p.date);
                var ds = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
                
                html += '<div class="post-item">';
                html += '<h2 class="post-title"><a href="?id=' + p.id + '">' + p.title.rendered + '</a></h2>';
                html += '<div class="post-meta"><span class="date">' + ds + '</span>';
                if (cat) html += '<span>' + cat + '</span>';
                html += '</div></div>';
            }
            
            document.getElementById('postList').innerHTML = html;
            renderPagination();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('postList').style.display = 'flex';
        })
        .catch(function(e) {
            document.getElementById('postList').innerHTML = '<p style="text-align:center;padding:2rem;">加载失败</p>';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('postList').style.display = 'flex';
        });
    }

    function getCategoryId(slug, callback) {
        fetch(getApi('categories', { slug: slug }))
        .then(function(r) { return r.json(); })
        .then(function(cats) {
            callback(cats[0] ? cats[0].id : null);
        })
        .catch(function() { callback(null); });
    }

    function renderPagination() {
        if (totalPages <= 1) {
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        
        var html = '';
        if (currentPage > 1) {
            html += '<button class="page-btn" onclick="goPage(' + (currentPage - 1) + ')">上一页</button>';
        }
        
        for (var i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                html += '<button class="page-btn ' + (i === currentPage ? 'active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
            }
        }
        
        if (currentPage < totalPages) {
            html += '<button class="page-btn" onclick="goPage(' + (currentPage + 1) + ')">下一页</button>';
        }
        
        document.getElementById('pagination').innerHTML = html;
    }

    window.goPage = function(p) {
        currentPage = p;
        loadPosts();
        window.scrollTo(0, 0);
    };

    window.showArchives = function() {
        document.getElementById('postList').style.display = 'none';
        document.getElementById('article').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('archives').style.display = 'block';
        
        fetch(getApi('posts', { _embed: true, per_page: 100 }))
        .then(function(r) { return r.json(); })
        .then(function(posts) {
            var y = {};
            for (var i = 0; i < posts.length; i++) {
                var yr = new Date(posts[i].date).getFullYear();
                if (!y[yr]) y[yr] = [];
                y[yr].push(posts[i]);
            }
            
            var html = '';
            var years = Object.keys(y).sort(function(a,b) { return b - a; });
            for (var j = 0; j < years.length; j++) {
                var yr = years[j];
                html += '<div class="archives-year"><h3>' + yr + ' 年</h3>';
                for (var k = 0; k < y[yr].length; k++) {
                    var p = y[yr][k];
                    var d = new Date(p.date);
                    var ds = pad(d.getMonth()+1) + '-' + pad(d.getDate());
                    html += '<div class="archive-item"><span class="archive-date">' + ds + '</span>';
                    html += '<span class="archive-title" onclick="showPost(' + p.id + ')">' + p.title.rendered + '</span></div>';
                }
                html += '</div>';
            }
            document.getElementById('archivesList').innerHTML = html;
        });
    };

    window.showPost = function(id) {
        document.getElementById('postList').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('archives').style.display = 'none';
        document.getElementById('article').style.display = 'block';
        
        fetch(getApi('posts/' + id, { _embed: true }))
        .then(function(r) { return r.json(); })
        .then(function(p) {
            var cat = '';
            try { cat = p._embedded['wp:term'][0][0].name; } catch(e) {}
            var d = new Date(p.date);
            var ds = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
            
            document.getElementById('articleContent').innerHTML = 
                '<header class="article-header"><h1 class="article-title">' + p.title.rendered + '</h1>' +
                '<div class="article-meta">' + ds + (cat ? ' · ' + cat : '') + '</div></header>' +
                '<div class="article-body">' + p.content.rendered + '</div>' +
                '<div class="source-link"><a href="' + p.link + '" target="_blank">原文链接</a></div>';
            
            if (window.twikoo) twikoo.init({ envId: TWIKOO, el: '#twikoo', path: 'wp-' + id });
        })
        .catch(function() {
            document.getElementById('articleContent').innerHTML = '<p>加载失败</p>';
        });
    };

    function pad(n) { return n < 10 ? '0' + n : n; }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
